<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Analysis Results - Dynastride</title>
    <link rel="stylesheet" href="results.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1>DYNASTRIDE</h1>
                <p class="tagline">Data-Driven Running Performance</p>
            </div>
            <button class="export-btn" onclick="exportPDF()">
                <span class="icon">üìÑ</span>
                Export PDF Report
            </button>
        </header>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Analyzing your race data...</p>
        </div>

        <!-- Results Content -->
        <div id="results-content" style="display: none;">
            <!-- Race Summary -->
            <section class="summary-section">
                <h2>Race Summary</h2>
                <div class="summary-grid">
                    <div class="summary-card primary">
                        <div class="card-icon">üèÉ</div>
                        <div class="card-content">
                            <h3>Race Performance</h3>
                            <div class="performance-score">
                                <div class="score-gauge" id="performance-gauge">
                                    <canvas id="gaugeChart"></canvas>
                                    <div class="score-value" id="score-value">--</div>
                                </div>
                                <div class="score-label" id="score-label">Analyzing...</div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <div class="card-icon">‚è±Ô∏è</div>
                        <div class="card-content">
                            <label>Total Time</label>
                            <div class="metric-value" id="total-time">--:--</div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <div class="card-icon">üìè</div>
                        <div class="card-content">
                            <label>Distance</label>
                            <div class="metric-value" id="distance">5.00 km</div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <div class="card-icon">‚ö°</div>
                        <div class="card-content">
                            <label>Average Pace</label>
                            <div class="metric-value" id="avg-pace">--:--</div>
                            <div class="metric-unit">/km</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Key Metrics -->
            <section class="metrics-section">
                <h2>Performance Metrics</h2>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">üíì</span>
                            <span class="metric-title">Heart Rate</span>
                            <span class="tooltip" data-tooltip="Heart rate zones indicate training intensity">?</span>
                        </div>
                        <div class="metric-main">
                            <span class="metric-big" id="avg-hr">--</span>
                            <span class="metric-unit">bpm avg</span>
                        </div>
                        <div class="metric-sub">
                            Max: <span id="max-hr">--</span> bpm
                        </div>
                        <div class="hr-zones" id="hr-zones">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">üëü</span>
                            <span class="metric-title">Cadence</span>
                            <span class="tooltip" data-tooltip="Steps per minute - optimal range is 170-180">?</span>
                        </div>
                        <div class="metric-main">
                            <span class="metric-big" id="avg-cadence">--</span>
                            <span class="metric-unit">spm</span>
                        </div>
                        <div class="metric-sub">
                            Target: 170-180 spm
                        </div>
                        <div class="cadence-indicator" id="cadence-indicator">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">‚õ∞Ô∏è</span>
                            <span class="metric-title">Elevation</span>
                            <span class="tooltip" data-tooltip="Total elevation gain and loss during race">?</span>
                        </div>
                        <div class="metric-main">
                            <span class="metric-big" id="elevation-gain">--</span>
                            <span class="metric-unit">m gain</span>
                        </div>
                        <div class="metric-sub">
                            Loss: <span id="elevation-loss">--</span> m
                        </div>
                    </div>

                    <div class="metric-card">
                        <div class="metric-header">
                            <span class="metric-icon">üéØ</span>
                            <span class="metric-title">VO2 Max</span>
                            <span class="tooltip" data-tooltip="Estimated maximal oxygen uptake">?</span>
                        </div>
                        <div class="metric-main">
                            <span class="metric-big" id="vo2max">--</span>
                            <span class="metric-unit">ml/kg/min</span>
                        </div>
                        <div class="metric-sub" id="vo2max-label">
                            -- Fitness Level
                        </div>
                    </div>
                </div>
            </section>

            <!-- Race Commentary -->
            <section class="commentary-section" id="commentary-section" style="display: none;">
                <h2>Race Analysis</h2>
                <div class="commentary-content" id="commentary-content">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Performance Charts -->
            <section class="charts-section">
                <h2>Performance Analysis</h2>

                <!-- Pace Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Pace Analysis</h3>
                        <p class="chart-description">Your pace throughout the race with training zones</p>
                    </div>
                    <canvas id="paceChart"></canvas>
                </div>

                <!-- Heart Rate Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Heart Rate Zones</h3>
                        <p class="chart-description">Heart rate distribution across training zones</p>
                    </div>
                    <canvas id="hrChart"></canvas>
                </div>

                <!-- Two Column Charts -->
                <div class="chart-row">
                    <div class="chart-container half">
                        <div class="chart-header">
                            <h3>Cadence</h3>
                            <p class="chart-description">Steps per minute</p>
                        </div>
                        <canvas id="cadenceChart"></canvas>
                    </div>

                    <div class="chart-container half">
                        <div class="chart-header">
                            <h3>Elevation Profile</h3>
                            <p class="chart-description">Course elevation</p>
                        </div>
                        <canvas id="elevationChart"></canvas>
                    </div>
                </div>

                <!-- Split Analysis -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3>Split Analysis</h3>
                        <p class="chart-description">Kilometer split times comparison</p>
                    </div>
                    <canvas id="splitsChart"></canvas>
                </div>

                <!-- Form Metrics -->
                <div class="form-metrics">
                    <h3>Running Form Metrics</h3>
                    <div class="form-grid">
                        <div class="form-gauge">
                            <label>Ground Contact Time</label>
                            <canvas id="gctGauge"></canvas>
                            <div class="gauge-value" id="gct-value">-- ms</div>
                            <div class="gauge-range">Optimal: 200-250ms</div>
                        </div>
                        <div class="form-gauge">
                            <label>Vertical Oscillation</label>
                            <canvas id="voGauge"></canvas>
                            <div class="gauge-value" id="vo-value">-- cm</div>
                            <div class="gauge-range">Optimal: 6-10cm</div>
                        </div>
                        <div class="form-gauge">
                            <label>Stride Length</label>
                            <canvas id="strideGauge"></canvas>
                            <div class="gauge-value" id="stride-value">-- m</div>
                            <div class="gauge-range">Optimal: 1.0-1.4m</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Analysis Insights -->
            <section class="insights-section">
                <h2>Key Insights</h2>
                <div class="insights-grid" id="insights-grid">
                    <!-- Populated by JS -->
                </div>
            </section>

            <!-- Training Recommendations -->
            <section class="recommendations-section">
                <h2>Training Recommendations</h2>

                <div class="recommendation-overview">
                    <div class="overview-card">
                        <h3>12-Week Goal</h3>
                        <div class="goal-time" id="goal-time">--:--</div>
                        <p class="goal-improvement" id="goal-improvement">-- improvement</p>
                    </div>

                    <div class="overview-card">
                        <h3>Training Focus</h3>
                        <ul class="focus-list" id="focus-list">
                            <!-- Populated by JS -->
                        </ul>
                    </div>
                </div>

                <div class="recommendations-list" id="recommendations-list">
                    <!-- Populated by JS -->
                </div>

                <div class="weekly-structure">
                    <h3>Recommended Weekly Structure</h3>
                    <div class="week-grid" id="week-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- Export Options -->
            <section class="export-section">
                <h2>Export Your Report</h2>
                <div class="export-options">
                    <div class="export-preview">
                        <div class="preview-image">
                            <div class="preview-placeholder">
                                üìä<br>
                                PDF Preview
                            </div>
                        </div>
                    </div>
                    <div class="export-controls">
                        <h3>Export Options</h3>
                        <label class="checkbox-label">
                            <input type="checkbox" id="include-charts" checked>
                            Include all charts and visualizations
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="include-metrics" checked>
                            Include detailed metrics
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" id="include-training" checked>
                            Include training plan
                        </label>
                        <button class="export-btn-large" onclick="exportPDF()">
                            <span class="icon">üìÑ</span>
                            Generate PDF Report
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Scripts -->
    <script src="app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Global variable to store analysis data for PDF export
        let globalAnalysisData = null;

        // Initialize results page when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Try to load analysis results from sessionStorage
            const analysisData = sessionStorage.getItem('analysisResults');

            if (analysisData) {
                try {
                    const results = JSON.parse(analysisData);
                    console.log('Loaded analysis results:', results);

                    // Store globally for PDF export
                    globalAnalysisData = results;

                    // Show loading briefly then display results
                    setTimeout(() => {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('results-content').style.display = 'block';

                        // Initialize charts with real data
                        if (typeof initializeResultsPage === 'function') {
                            initializeResultsPage(results);
                        }
                    }, 1000);
                } catch (error) {
                    console.error('Failed to parse analysis results:', error);
                    showErrorAndRedirect();
                }
            } else {
                // No data found, redirect back to upload
                console.warn('No analysis data found in sessionStorage');
                showErrorAndRedirect();
            }
        });

        function showErrorAndRedirect() {
            document.getElementById('loading').innerHTML = '<p>No race data found. Redirecting to upload page...</p>';
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        }

        // PDF Export Function
        async function exportPDF() {
            if (!globalAnalysisData) {
                alert('No analysis data available for export.');
                return;
            }

            // Show loading state on button
            const buttons = document.querySelectorAll('.export-btn, .export-btn-large');
            buttons.forEach(btn => {
                btn.disabled = true;
                btn.innerHTML = '<span class="icon">‚è≥</span> Generating PDF...';
            });

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                const pageWidth = pdf.internal.pageSize.getWidth();
                let yPos = 20;

                // Helper functions
                const addText = (text, size = 12, bold = false, color = [0, 0, 0]) => {
                    pdf.setFontSize(size);
                    pdf.setFont('helvetica', bold ? 'bold' : 'normal');
                    pdf.setTextColor(...color);
                    pdf.text(text, 20, yPos);
                    yPos += size * 0.5;
                };

                const addWrappedText = (text, maxWidth = 170) => {
                    const lines = pdf.splitTextToSize(text, maxWidth);
                    lines.forEach(line => {
                        pdf.text(line, 20, yPos);
                        yPos += 6;
                    });
                };

                const formatTime = (seconds) => {
                    const mins = Math.floor(seconds / 60);
                    const secs = Math.round(seconds % 60);
                    return `${mins}:${String(secs).padStart(2, '0')}`;
                };

                const kmToMiles = (km) => (km * 0.621371).toFixed(2);

                const formatPacePerMile = (pacePerKm) => {
                    const pacePerMile = pacePerKm * 1.609344;
                    const mins = Math.floor(pacePerMile);
                    const secs = Math.round((pacePerMile % 1) * 60);
                    return `${mins}:${String(secs).padStart(2, '0')}`;
                };

                // Title
                addText('DYNASTRIDE 5K ANALYSIS REPORT', 20, true, [102, 126, 234]);
                yPos += 10;

                // Date
                const date = new Date().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                addText(`Generated: ${date}`, 10, false, [107, 114, 128]);
                yPos += 10;

                // Race Summary
                addText('RACE SUMMARY', 16, true);
                yPos += 5;

                const { metrics, analysis } = globalAnalysisData;
                addText(`Finish Time: ${formatTime(metrics.totalTime)}`, 12);
                addText(`Distance: ${kmToMiles(metrics.totalDistance)} miles`, 12);
                addText(`Average Pace: ${formatPacePerMile(metrics.avgPace)} /mile`, 12);
                addText(`Average Heart Rate: ${Math.round(metrics.avgHeartRate)} bpm`, 12);
                addText(`Cadence: ${Math.round(metrics.avgCadence)} spm`, 12);

                if (analysis.vo2Max) {
                    addText(`VO2 Max: ${analysis.vo2Max} ml/kg/min`, 12);
                }

                if (metrics.elevationGain !== undefined) {
                    addText(`Elevation Gain: ${metrics.elevationGain}m`, 12);
                }

                yPos += 10;

                // Race Commentary
                if (analysis.raceCommentary && analysis.raceCommentary.length > 0) {
                    addText('RACE ANALYSIS', 16, true);
                    yPos += 5;

                    analysis.raceCommentary.forEach(paragraph => {
                        pdf.setFontSize(10);
                        pdf.setFont('helvetica', 'normal');
                        pdf.setTextColor(0, 0, 0);
                        addWrappedText(paragraph);
                        yPos += 3;
                    });

                    yPos += 10;
                }

                // Check if we need a new page
                if (yPos > 250) {
                    pdf.addPage();
                    yPos = 20;
                }

                // Training Recommendations
                if (analysis.trainingRecommendations) {
                    addText('TRAINING RECOMMENDATIONS', 16, true);
                    yPos += 5;

                    const recs = analysis.trainingRecommendations;

                    if (recs.weeklyGoal) {
                        addText('12-Week Goal:', 14, true);
                        addText(`Current Time: ${recs.weeklyGoal.currentTime}`, 12);
                        addText(`Target Time: ${recs.weeklyGoal.goalTime}`, 12);
                        addText(`Improvement: ${recs.weeklyGoal.improvement}`, 12);
                        yPos += 5;
                    }

                    if (recs.trainingFocus && recs.trainingFocus.length > 0) {
                        addText('Training Focus:', 14, true);
                        recs.trainingFocus.forEach(focus => {
                            pdf.setFontSize(11);
                            pdf.text(`‚Ä¢ ${focus}`, 25, yPos);
                            yPos += 6;
                        });
                        yPos += 5;
                    }

                    if (recs.workoutPlan && recs.workoutPlan.length > 0) {
                        // Check if we need a new page
                        if (yPos > 200) {
                            pdf.addPage();
                            yPos = 20;
                        }

                        addText('Weekly Workout Plan:', 14, true);
                        recs.workoutPlan.forEach(workout => {
                            pdf.setFontSize(11);
                            pdf.setFont('helvetica', 'bold');
                            pdf.text(`${workout.day}:`, 25, yPos);
                            yPos += 5;

                            pdf.setFont('helvetica', 'normal');
                            pdf.text(`${workout.workout}`, 30, yPos);
                            yPos += 5;
                            pdf.setFontSize(9);
                            pdf.setTextColor(100, 100, 100);
                            pdf.text(`${workout.duration} ‚Ä¢ ${workout.intensity}`, 30, yPos);
                            yPos += 5;
                            pdf.setTextColor(0, 0, 0);
                        });
                    }
                }

                // Footer on last page
                pdf.setFontSize(9);
                pdf.setTextColor(107, 114, 128);
                pdf.text('www.dynastride.com | USATF Level 1 Certified Coach', pageWidth / 2, 280, { align: 'center' });

                // Download PDF
                const filename = `Dynastride-5K-Analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(filename);

                showNotification('PDF report generated successfully!', 'success');

            } catch (error) {
                console.error('PDF export failed:', error);
                showNotification('Failed to generate PDF: ' + error.message, 'error');
            } finally {
                // Restore button state
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.innerHTML = '<span class="icon">üìÑ</span> Export PDF Report';
                });
            }
        }

        // Show notification helper
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#667eea'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                font-weight: 500;
            `;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Add animation styles
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOut {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
